<!-- Title:  Build procedure for the project SRRQA AirValid Service -->
<!-- Author: pierfrancesco.vallosio@mce.it -->
<!-- Date:   16-Febbraio-2023 -->

<project name="SRRQA - AirValid Service" default="all" basedir="." xmlns:ivy="antlib:fr.jayasoft.ivy.ant">

	<description>
		Build procedure for the project AirValid Service
	</description>

	<property file="buildfiles/build.properties" />
	<property file="buildfiles/${target}.properties" />

	<path id="library.ref">
		<fileset dir="${lib}">
			<include name="**/*.jar" />
			<include name="**/*.zip" />
		</fileset>
	</path>

	<target name="init">
		<!-- Create the time stamp -->
		<tstamp />
		<!-- Create the build directory structure used by compile -->
		<mkdir dir="${build}" />
	</target>

	<target name="all" depends="dist-airvalidSrv" description="Generate AirValid Service application archives">
	</target>

	<target name="clean-all" depends="clean" description="Clean all">
	</target>

	<target name="clean" description="Clean the files generated by build process">
		<delete dir="${build}" />
		<delete dir="${dist}" />
	</target>

	<target name="compile-airvalidSrv" depends="init" description="Compile AirValid Service">
		<mkdir dir="${build}/airvalidsrv/classes" />
		<javac includeantruntime="false" target="1.8" source="1.8" srcdir="${src}/java/it/csi" destdir="${build}/airvalidsrv/classes" optimize="on" deprecation="on" compiler="modern" fork="yes" debug="on" debuglevel="lines,vars,source" encoding="UTF-8">
			<classpath refid="library.ref" />
		</javac>
	</target>

	<target name="dist-airvalidSrv" depends="compile-airvalidSrv" description="Generate AirValid Service archive">
		<mkdir dir="${dist}/airvalidsrv" />
		<mkdir dir="${build}/airvalidsrv/conf" />
		<copy file="${src}/etc/log4j.properties" todir="${build}/airvalidsrv/classes" />
		<copy file="${src}/etc/META-INF/context.xml" todir="${build}/airvalidsrv/conf" />
		<replace file="${build}/airvalidsrv/conf/context.xml" token="@@@@SERVICE_NAME@@@@" value="${service_name}" />
		<replace file="${build}/airvalidsrv/conf/context.xml" token="@@@@SERVICE_URL@@@@" value="${service_url}" />
		<replace file="${build}/airvalidsrv/conf/context.xml" token="@@@@SERVICE_USER@@@@" value="${service_user}" />
		<replace file="${build}/airvalidsrv/conf/context.xml" token="@@@@SERVICE_PWD@@@@" value="${service_pwd}" />
		<replace file="${build}/airvalidsrv/conf/context.xml" token="@@@@COP_SRV_URL@@@@" value="${cop_srv_url}" />
		<replace file="${build}/airvalidsrv/conf/context.xml" token="@@@@COP_SRV_USER@@@@" value="${cop_srv_user}" />
		<replace file="${build}/airvalidsrv/conf/context.xml" token="@@@@COP_SRV_PWD@@@@" value="${cop_srv_pwd}" />
		<replace file="${build}/airvalidsrv/conf/context.xml" token="@@@@AUTH_URL@@@@" value="${auth_url}" />
		<replace file="${build}/airvalidsrv/conf/context.xml" token="@@@@AUTH_USER@@@@" value="${auth_user}" />
		<replace file="${build}/airvalidsrv/conf/context.xml" token="@@@@AUTH_PWD@@@@" value="${auth_pwd}" />
		<replace file="${build}/airvalidsrv/conf/context.xml" token="@@@@ENABLE_SHIBBOLET@@@@" value="${enable_shibbolet}" />
		<replace file="${build}/airvalidsrv/conf/context.xml" token="@@@@MEASURE_LOCK_TIMEOUT_m@@@@" value="${measureLockTimeout_m}" />
		<replace file="${build}/airvalidsrv/classes/log4j.properties" token="@@@@SERVICE_NAME@@@@" value="${service_name}" />
		<war destfile="${dist}/airvalidsrv/${war-file-name}" webxml="${src}/etc/web.xml">
			<classes dir="${build}/airvalidsrv/classes" />
			<lib dir="${lib}" excludes="servlet-api-2.5.jar" />
			<metainf dir="${build}/airvalidsrv/conf" />
		</war>
	</target>

	<target name="install-airvalidSrv" depends="dist-airvalidSrv" description="Deploy AirValid Service">
		<exec dir="${dist}/airvalidsrv" executable="scp" os="Linux">
			<arg line="${war-file-name} ${deploy_user}@${deploy_host}:${deploy_folder}" />
		</exec>
	</target>

	<target name="release" depends="dist-airvalidSrv" description="Generate AirValid Service release">
		<!-- Create the distribution directory -->
		<mkdir dir="${dist}/airvalidsrv" />
		<tar destfile="${dist}/airvalidsrv/${prodotto}_bin_${dist-file-name}.tar">
			<tarfileset file="${dist}/airvalidsrv/${war-file-name}" mode="644" />
		</tar>
		<tar destfile="${dist}/airvalidsrv/${prodotto}_src_${dist-file-name}.tar">
			<tarfileset dir="${basedir}">
				<include name="src/**" />
				<include name="buildfiles/**" />
				<include name="doc/**" />
				<include name="AUTHORS.txt" />
				<include name="BOM.csv" />
				<include name="build.xml" />
				<include name="changelog.md" />
				<include name="CodeOfConduct.md" />
				<include name="CONTRIBUTORS.txt" />
				<include name="Copyrights.txt" />
				<include name="LICENSE" />
				<include name="Maintainers.txt" />
				<include name="README.md" />
			</tarfileset>
		</tar>
	</target>

</project>
